# Story 3.3: User Progress Tracking System

## Status
Draft

## Story
**As a** language learner,  
**I want** my learning progress automatically saved,  
**so that** I can resume study sessions where I left off and track my advancement.

## Acceptance Criteria
1. Progress table storing user_id, movie_id, current_line_number, last_accessed timestamp
2. Automatic progress saving as user advances through subtitle lines
3. Resume functionality returning user to last studied line when reopening movie
4. Session duration tracking for learning analytics
5. Lines completed counter for each movie and overall totals
6. Progress percentage display for current movie completion status
7. Recently studied movies list on user dashboard for quick access
8. Progress data persisted across browser sessions and devices

## Tasks / Subtasks
- [ ] Implement Backend Progress API Endpoints (AC: 1, 2, 8)
  - [ ] Create GET /api/progress/{sub_link_id} endpoint to retrieve user progress
  - [ ] Create PUT /api/progress/{sub_link_id} endpoint for progress updates
  - [ ] Add database transaction handling for progress persistence
  - [ ] Implement progress validation and error handling
  - [ ] Add user authentication validation for progress endpoints

- [ ] Create Progress Service Layer (AC: 2, 4)
  - [ ] Implement ProgressService class with business logic
  - [ ] Add automatic progress calculation methods
  - [ ] Create session duration tracking functionality
  - [ ] Implement alignment completion counting logic
  - [ ] Add progress percentage calculation methods

- [ ] Enhance Frontend Progress Management (AC: 2, 3, 6)
  - [ ] Extend progress-tracker.js module with automatic saving
  - [ ] Implement progress restoration on learning interface initialization
  - [ ] Add progress percentage display to learning interface
  - [ ] Create offline progress queue with retry logic
  - [ ] Add visual progress indicators and completion feedback

- [ ] Implement Dashboard Progress Display (AC: 5, 7)
  - [ ] Create recently studied movies section on dashboard
  - [ ] Add overall progress statistics display
  - [ ] Implement movie completion counters and totals
  - [ ] Add quick access links to resume learning sessions
  - [ ] Create progress history and analytics display

- [ ] Database Integration and Migration (AC: 1, 8)
  - [ ] Create database migration for user_progress table enhancements
  - [ ] Implement UserProgress model with all required fields
  - [ ] Add database indexes for performance optimization
  - [ ] Create data validation and constraint handling
  - [ ] Add cascade delete handling for user account cleanup

- [ ] Create Comprehensive Testing Suite (Testing)
  - [ ] Test progress API endpoints with various scenarios
  - [ ] Test automatic progress saving during learning sessions
  - [ ] Test progress restoration accuracy and edge cases
  - [ ] Test session duration tracking and calculations
  - [ ] Test dashboard progress display and statistics
  - [ ] Test offline progress queue and retry functionality

## Dev Notes

### Previous Story Dependencies
From Story 3.2 (Subtitle Navigation and Playback Controls):
- SubtitlePlayer module available with navigation framework and auto-play functionality
- DualSubtitleDisplay component with progress tracking integration
- Progress tracking system partially implemented with UserProgress model
- Alignment data loading with pagination (50 alignments per batch) functional
- localStorage management established via storage-helper.js utility
- Progress bar component available for enhancement with detailed statistics
- Learning interface foundation established with session state management

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Backend Framework**: Flask 2.3.x with SQLAlchemy for database operations
- **Database**: SQLite 3.x with WAL mode for progress persistence optimization
- **Frontend State Management**: Browser localStorage for offline progress queue
- **API Style**: REST endpoints with JSON responses for progress operations
- **Authentication**: Flask-Login sessions for secure progress tracking
- **Frontend Language**: JavaScript (ES6+) for progress tracking utilities

### Data Models Required
[Source: architecture/data-models.md#userprogress]
**UserProgress Model (Enhanced):**
- id: INTEGER (Primary Key) - Unique progress identifier
- user_id: INTEGER - Foreign key to users table
- sub_link_id: INTEGER - Foreign key to sub_links table (specific translation pair)
- current_alignment_index: INTEGER - Position in the link_data alignment array
- total_alignments_completed: INTEGER - Count of completed alignment pairs
- last_accessed: DATETIME - When user last studied this content
- session_duration_minutes: INTEGER - Time spent in current session

**Progress Data Schema (Frontend):**
```typescript
interface ProgressData {
  sub_link_id: number;
  current_alignment_index: number;
  total_alignments_completed: number;
  completion_percentage: number;
  session_duration_minutes: number;
  last_accessed: string;
}
```

### API Specifications Required
[Source: architecture/api-specification.md#progress-tracking-endpoints]

**GET /api/progress/{sub_link_id}:**
- Retrieves existing progress for specific subtitle pair
- Returns 404 if no progress exists (new learning session)
- Includes completion statistics and session history
- Requires user authentication via session cookies

**PUT /api/progress/{sub_link_id}:**
- Updates progress with current position and session data
- Accepts current_alignment_index and session_duration_minutes
- Calculates total_alignments_completed and completion percentage
- Uses database transactions for atomic updates
- Returns updated progress data with statistics

### Frontend Component Enhancements Required
[Source: architecture/frontend-architecture.md#component-architecture]

**ProgressTracker Module (New):**
- `app/static/js/modules/progress-tracker.js` - Core progress management
- Automatic progress saving every 5 alignments during navigation
- Session duration tracking with start/pause/resume functionality
- Offline progress queue with retry logic for network failures
- Progress restoration API for learning interface initialization

**Dashboard Components (Enhanced):**
- Recently studied movies component with resume functionality
- Overall progress statistics display with completion counters
- Movie-specific progress bars with percentage completion
- Session history and learning analytics dashboard

**Learning Interface Progress Integration:**
- Real-time progress percentage display in subtitle player
- Visual feedback for milestone achievements (25%, 50%, 75%, 100%)
- Automatic progress checkpoint saving during session
- Progress restoration on learning interface load

### Backend Service Architecture Required
[Source: architecture/backend-architecture.md#service-architecture]

**ProgressService Class:**
- `app/services/progress_service.py` - Business logic for progress operations
- Methods: `get_user_progress()`, `update_progress()`, `calculate_completion()`
- Session duration aggregation and analytics calculations
- Progress validation and boundary checking
- Database transaction management for atomic updates

**Progress API Endpoints:**
- `app/blueprints/api/progress.py` - REST API endpoint handlers
- User authentication validation using `@login_required`
- Input validation with WTForms for progress data
- Error handling with consistent JSON response format
- Rate limiting protection for progress update endpoints

### Database Schema Enhancements
[Source: architecture/database-schema.md]
**UserProgress Table (Existing - Verify Structure):**
```sql
CREATE TABLE IF NOT EXISTS user_progress (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    sub_link_id INTEGER NOT NULL,
    current_alignment_index INTEGER DEFAULT 0,
    total_alignments_completed INTEGER DEFAULT 0,
    session_duration_minutes INTEGER DEFAULT 0,
    last_accessed DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (sub_link_id) REFERENCES sub_links(id) ON DELETE CASCADE,
    UNIQUE(user_id, sub_link_id)
);
```

**Required Indexes for Performance:**
- `idx_user_progress_user` ON user_progress(user_id)
- `idx_user_progress_link` ON user_progress(sub_link_id)
- `idx_user_progress_accessed` ON user_progress(last_accessed)

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]

**Backend Files:**
- Model: `app/models/progress.py` - UserProgress SQLAlchemy model (verify exists)
- Service: `app/services/progress_service.py` - Progress business logic
- API: `app/blueprints/api/progress.py` - Progress REST endpoints
- Migration: `migrations/versions/xxx_enhance_user_progress.py` - Database updates

**Frontend Files:**
- Module: `app/static/js/modules/progress-tracker.js` - Core progress tracking
- Component: `app/static/js/components/progress-indicator.js` - Visual progress displays
- Utility: `app/static/js/utils/storage-helper.js` - Enhanced localStorage management (exists)
- Template: `app/templates/main/dashboard.html` - Dashboard progress sections

### Security Requirements
[Source: architecture/coding-standards.md#critical-fullstack-rules]
**Progress Tracking Security:**
- **Authentication Validation**: All progress endpoints require `@login_required` decorator
- **Data Ownership**: Validate user owns progress records before updates
- **Input Sanitization**: Validate alignment indices and duration values
- **Transaction Safety**: Use database transactions for progress updates
- **Rate Limiting**: Prevent excessive progress update requests (max 10/min)
- **Session Security**: Never store sensitive progress data in localStorage

### Performance Requirements
[Source: architecture/coding-standards.md#critical-fullstack-rules]
**Pi Resource Optimization for Progress:**
- **Batch Progress Updates**: Update server every 5 alignments, not every navigation
- **Memory-Conscious Queries**: Never load all user progress at once - use pagination
- **Database Transactions**: Use SQLAlchemy transactions for atomic progress persistence
- **Offline Queue Management**: Store failed progress updates in localStorage queue
- **Cache Progress Data**: Cache current session progress client-side to reduce API calls

### Integration Points
**SubtitlePlayer Integration (From Story 3.2):**
- Extend existing navigation methods to trigger progress updates
- Integrate with auto-play functionality for automatic progress advancement
- Add progress checkpoint saving during session pause/resume
- Connect progress restoration to learning interface initialization

**Dashboard Integration:**
- Add recently studied movies section with progress data
- Create overall learning statistics display
- Implement quick resume functionality for incomplete sessions
- Display progress history and learning analytics

## Testing Standards
[Source: architecture/testing-strategy.md]
**Backend Testing Requirements:**
- **Test File Location**: `tests/test_services/test_progress_service.py`, `tests/test_api/test_progress_endpoints.py`
- **Test Framework**: pytest with fixtures for database setup
- **Test Configuration**: SQLite in-memory database for isolated testing

**Manual Testing Requirements:**
- **Test File Location**: All tests in `manual_tests/` directory organized by feature area
- **Test Framework**: Manual testing checklists for UI validation
- **Test Configuration**: Browser-based testing across desktop and mobile devices

**Specific Testing Requirements for Story 3.3:**
- Test automatic progress saving during learning sessions
- Test progress restoration accuracy when resuming movies
- Test session duration tracking and calculations
- Test progress percentage calculations and display accuracy
- Test dashboard progress statistics and recently studied movies
- Test offline progress queue and retry functionality
- Test boundary conditions (first/last alignments, zero progress)
- Test concurrent progress updates and race condition handling

**Test Organization for This Story:**
```
tests/
├── test_services/
│   └── test_progress_service.py      # Progress business logic testing
├── test_api/
│   └── test_progress_endpoints.py    # Progress API endpoint testing
└── test_models/
    └── test_progress.py              # UserProgress model testing

manual_tests/
├── progress_tracking_checklist.md    # Automatic progress saving testing
├── progress_restoration_testing.md   # Resume functionality validation
├── dashboard_progress_testing.md     # Dashboard statistics testing
└── offline_progress_testing.md       # Offline queue and retry testing
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-19 | 1.0 | Initial story draft creation | Bob (SM Agent) |