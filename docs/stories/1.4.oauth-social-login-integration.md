# Story 1.4: OAuth Social Login Integration

## Status
Draft

## Story
**As a** busy professional,  
**I want** to login using my Google, Facebook, or Apple account,  
**so that** I can quickly access the platform without managing another password.

## Acceptance Criteria
1. OAuth client configuration for Google, Facebook, and Apple providers
2. OAuth login buttons prominently displayed on authentication pages
3. OAuth callback handling for successful authentication flow
4. User account creation for first-time OAuth users
5. Account linking for existing users who choose to add OAuth
6. OAuth token secure storage and session management
7. Fallback error handling for OAuth failures with clear user messaging
8. User profile indicates OAuth authentication method used

## Tasks / Subtasks
- [ ] Configure OAuth Client Settings for All Providers (AC: 1)
  - [ ] Install required OAuth libraries (Authlib, requests-oauthlib)
  - [ ] Set up environment variables for Google, Facebook, and Apple client credentials
  - [ ] Create OAuth configuration in Flask app factory
  - [ ] Configure OAuth client instances for each provider with proper scopes

- [ ] Create OAuth Handler Service Layer (AC: 1, 3, 4, 5)
  - [ ] Create `app/services/oauth_service.py` with provider-specific handlers
  - [ ] Implement Google OAuth handler with userinfo retrieval
  - [ ] Implement Facebook OAuth handler with profile API integration
  - [ ] Implement Apple OAuth handler with JWT token validation
  - [ ] Add user account creation logic for first-time OAuth users
  - [ ] Add account linking logic for existing users

- [ ] Implement OAuth Routes and Callbacks (AC: 3, 4, 6, 7)
  - [ ] Create OAuth initiation routes `/auth/oauth/<provider>`
  - [ ] Create OAuth callback routes `/auth/oauth/<provider>/callback`
  - [ ] Implement secure state parameter validation for CSRF protection
  - [ ] Add OAuth token secure storage in Flask sessions
  - [ ] Implement comprehensive error handling with user-friendly messages
  - [ ] Add proper redirect logic post-authentication

- [ ] Update Authentication Templates with OAuth Buttons (AC: 2)
  - [ ] Add OAuth provider buttons to login.html template
  - [ ] Add OAuth provider buttons to register.html template
  - [ ] Style OAuth buttons with Bootstrap and provider brand guidelines
  - [ ] Add fallback messaging for OAuth failures

- [ ] Update User Model and Profile Display (AC: 8)
  - [ ] Verify existing User model supports oauth_provider and oauth_id fields
  - [ ] Update user profile template to display OAuth authentication method
  - [ ] Add OAuth provider icons/indicators in user interface

- [ ] Create Comprehensive OAuth Integration Tests (Testing)
  - [ ] Test OAuth service layer with mocked provider responses
  - [ ] Test OAuth callback handling with valid and invalid codes
  - [ ] Test new user creation via OAuth flow
  - [ ] Test account linking for existing users
  - [ ] Test OAuth error scenarios and fallback behavior
  - [ ] Test CSRF protection with state parameter validation

## Dev Notes

### Previous Story Insights
From Story 1.3:
- Flask-Login is fully configured with session management and user loader callback
- User model includes oauth_provider and oauth_id fields with proper constraints
- Authentication blueprint structure established in `app/blueprints/auth/`
- Service layer architecture pattern implemented in `app/services/auth_service.py`
- Session security properly configured with Flask-Login
- Error handling follows consistent JSON response format
- Authentication templates use Bootstrap 5.3 styling

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Authentication**: Flask-Login 0.6.x for user sessions and social login integration
- **OAuth Library**: Authlib or requests-oauthlib for OAuth 2.0 provider integration
- **Backend Framework**: Flask 2.3.x with existing blueprint architecture
- **Frontend Framework**: Vanilla JS + Bootstrap 5.3 for OAuth button styling
- **Database**: SQLite with existing User model supporting OAuth fields

### OAuth Provider Integration Requirements
[Source: architecture/external-apis.md]
**Google OAuth 2.0:**
- Authorization URL: `https://accounts.google.com/o/oauth2/v2/auth`
- Token URL: `https://oauth2.googleapis.com/token`
- UserInfo URL: `https://oauth2.googleapis.com/oauth2/v2/userinfo`
- Required scope: `openid email profile`
- Environment variables: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`

**Facebook Login API:**
- Authorization URL: `https://www.facebook.com/v18.0/dialog/oauth`
- Token URL: `https://graph.facebook.com/v18.0/oauth/access_token`
- Profile URL: `https://graph.facebook.com/v18.0/me`
- Required scope: `email`
- Environment variables: `FACEBOOK_CLIENT_ID`, `FACEBOOK_CLIENT_SECRET`

**Apple Sign-In API:**
- Authorization URL: `https://appleid.apple.com/auth/authorize`
- Token URL: `https://appleid.apple.com/auth/token`
- Authentication: JWT signing with Apple private key
- Required scope: `name email`
- Environment variables: `APPLE_CLIENT_ID`, `APPLE_TEAM_ID`, `APPLE_KEY_ID`, `APPLE_PRIVATE_KEY`

### Data Models Available
[Source: architecture/data-models.md]
User model already supports OAuth integration:
- oauth_provider: VARCHAR(50) - OAuth provider (google, facebook, apple, null)
- oauth_id: VARCHAR(255) - OAuth provider user ID
- email: VARCHAR(255) - User's email address (unique constraint)
- Database constraint: UNIQUE(oauth_provider, oauth_id) prevents duplicate OAuth accounts

### Core Workflow Integration
[Source: architecture/core-workflows.md#new-user-registration-with-oauth]
OAuth user registration flow:
1. User clicks OAuth provider button → `/auth/oauth/<provider>`
2. Redirect to OAuth provider with state parameter for CSRF protection
3. OAuth callback with authorization code → `/auth/oauth/<provider>/callback`
4. Exchange code for access token and retrieve user profile
5. Check if user exists by oauth_provider + oauth_id
6. If new user: Create user record, redirect to language selection
7. If existing user: Login and redirect to dashboard
8. Handle OAuth failures with fallback to email/password registration

### API Specifications Required
[Source: architecture/api-specification.md]
OAuth endpoints to implement:
- `GET /auth/oauth/{provider}` - OAuth initiation redirect (provider: google, facebook, apple)
- `GET /auth/oauth/{provider}/callback` - OAuth callback handler
- State parameter validation for CSRF protection
- Session-based authentication integration with Flask-Login

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
OAuth component locations:
- OAuth handlers: `app/blueprints/auth/oauth_handlers.py`
- OAuth service: `app/services/oauth_service.py`
- OAuth routes: Extend existing `app/blueprints/auth/routes.py`
- Templates: Update existing `app/templates/auth/*.html`
- Tests: `tests/test_oauth_integration.py`

### Security Requirements
[Source: architecture/coding-standards.md]
Critical OAuth security rules:
- **OAuth State Management**: Always validate OAuth state parameter and store callback URLs in session to prevent CSRF attacks
- **Session Security**: Never store sensitive OAuth tokens in client-side storage - use Flask sessions only
- **Input Sanitization**: Always validate OAuth provider responses and escape user content in templates
- **Error Response Consistency**: All OAuth endpoints must return JSON errors with consistent structure for frontend handling

### Frontend Integration Requirements
[Source: architecture/unified-project-structure.md]
OAuth frontend components:
- OAuth button styling: Bootstrap 5.3 with provider brand guidelines
- Error handling: JavaScript module `app/static/js/modules/auth.js`
- State management: Browser SessionStorage for OAuth flow state
- API client: Extend existing `app/static/js/utils/api-client.js` for OAuth endpoints

### File Locations for New Code
[Source: architecture/unified-project-structure.md]
- OAuth service layer: `app/services/oauth_service.py`
- OAuth handlers: `app/blueprints/auth/oauth_handlers.py`
- OAuth routes: Extend `app/blueprints/auth/routes.py`
- Template updates: `app/templates/auth/login.html`, `app/templates/auth/register.html`
- OAuth integration tests: `tests/test_oauth_integration.py`
- Requirements update: `requirements.txt` (add Authlib or requests-oauthlib)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test File Location**: All tests in `tests/` directory
- **Test Framework**: pytest 7.x for backend unit and integration testing
- **Test Configuration**: Use `tests/conftest.py` for pytest configuration and fixtures
- **Test Organization**: Organize tests by component type (services, api, integration)

**Specific Requirements for OAuth Integration Story**:
- Test OAuth service layer with mocked provider responses (Google, Facebook, Apple)
- Test OAuth callback handling with valid authorization codes and error scenarios
- Test new user account creation through OAuth flow with language pair selection
- Test account linking for existing users who add OAuth authentication
- Test CSRF protection with state parameter validation throughout OAuth flow
- Test OAuth error scenarios (provider downtime, invalid credentials, user cancellation)
- Test session management and Flask-Login integration with OAuth tokens
- Test OAuth provider profile data retrieval and user record creation

**Test Organization for This Story**:
```
tests/
├── test_services/
│   └── test_oauth_service.py        # OAuth provider service tests
├── test_api/
│   └── test_oauth_endpoints.py      # OAuth route and callback tests
└── test_integration/
    └── test_oauth_integration.py    # Complete OAuth flow tests
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)