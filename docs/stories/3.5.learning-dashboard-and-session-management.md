# Story 3.5: Learning Dashboard and Session Management

## Status
Ready for Review

## Story
**As a** language learner,  
**I want** to view my overall learning progress and manage my study sessions,  
**so that** I can track advancement and maintain motivation for continued learning.

## Acceptance Criteria
1. Dashboard displaying total study time, movies completed, and lines studied
2. Recent activity showing last studied movies with resume options
3. Learning streak counter tracking consecutive days of study activity
4. Weekly/monthly progress charts showing study consistency and advancement
5. Personal learning statistics including average session duration and completion rates
6. Quick access to bookmarked content and favorite movies from dashboard
7. Learning goals setting and progress tracking toward user-defined targets
8. Session history with detailed breakdown of time spent per movie and language pair

## Tasks / Subtasks
- [x] Enhance Backend Dashboard API Endpoints (AC: 1, 2, 4, 5, 8)
  - [x] Extend GET /api/progress/dashboard with comprehensive learning statistics
  - [x] Add GET /api/progress/charts endpoint for weekly/monthly progress data
  - [x] Create GET /api/progress/streak endpoint for consecutive learning days calculation
  - [x] Implement GET /api/progress/session-history with movie-language breakdown
  - [x] Add statistical calculations for completion rates and session averages

- [x] Implement Learning Goals System (AC: 7)
  - [x] Create LearningGoal SQLAlchemy model with target types and deadlines
  - [x] Implement POST /api/goals and GET /api/goals endpoints
  - [x] Add goal progress tracking and completion status calculations
  - [x] Create PUT /api/goals/{goal_id} for goal updates and DELETE endpoint
  - [x] Database migration for learning_goals table

- [x] Create Session Analytics Service (AC: 8)
  - [x] Implement SessionAnalyticsService with movie-language pair breakdowns
  - [x] Add streak calculation algorithm for consecutive learning days
  - [x] Create progress chart data generation for weekly/monthly views
  - [x] Implement session duration analytics and averaging calculations
  - [x] Add learning velocity tracking (alignments per session/hour)

- [x] Enhanced Frontend Dashboard Components (AC: 1, 3, 4, 6)
  - [x] Upgrade existing DashboardProgress class with enhanced statistics
  - [x] Create progress charts using Chart.js for weekly/monthly visualization
  - [x] Implement learning streak display with visual streak indicators
  - [x] Add quick access sections for bookmarks and favorite movies integration
  - [x] Create session history timeline with movie-language details

- [x] Goals Management Interface (AC: 7)
  - [x] Create goals management section within dashboard template
  - [x] Implement goal creation modal with target types and deadlines
  - [x] Add goal progress visualization with completion percentages
  - [x] Create goal editing and deletion functionality
  - [x] Add goal achievement notifications and celebration UI

- [x] Advanced Analytics Dashboard (AC: 4, 5, 8)
  - [x] Implement Chart.js integration for progress visualization
  - [x] Create learning velocity charts showing alignments/time trends
  - [x] Add completion rate analytics with success/failure pattern analysis
  - [x] Implement session history view with detailed movie-language breakdowns
  - [x] Create exportable learning reports for user download

- [x] Create Comprehensive Testing Suite (Testing)
  - [x] Test dashboard statistics calculations and API endpoints
  - [x] Test learning goals CRUD operations and progress tracking
  - [x] Test streak calculation accuracy and edge cases
  - [x] Test progress charts data generation and visualization
  - [x] Test session analytics and historical data retrieval
  - [x] Test goals management interface and notification systems

## Dev Notes

### Previous Story Dependencies
From Story 3.4 (Bookmark Functionality):
- Bookmark model and BookmarkService available for dashboard integration
- Bookmark management functionality for quick access implementation
- API patterns established for user-specific data retrieval
- Dashboard template with progress tracking foundation implemented
- Frontend bookmark-manager.js module available for integration

From Story 3.3 (User Progress Tracking System):
- UserProgress model with comprehensive tracking data available
- Progress tracking API endpoints functional
- Session duration tracking and analytics foundation established
- Database patterns for progress persistence implemented

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Backend Framework**: Flask 2.3.x with SQLAlchemy for goals and analytics persistence
- **Database**: SQLite 3.x with WAL mode for analytics query optimization
- **Frontend Charting**: Chart.js library for progress visualization components
- **API Style**: REST endpoints with JSON responses for dashboard data delivery
- **Authentication**: Flask-Login sessions for secure analytics access
- **Frontend Language**: JavaScript (ES6+) for enhanced dashboard interface components

### Data Models Required
[Source: architecture/data-models.md]
**Enhanced UserProgress Analytics:**
- Existing UserProgress model provides foundation for analytics calculations
- session_duration_minutes field available for session statistics
- last_accessed timestamps for streak calculations
- total_alignments_completed for completion rate analytics

**New LearningGoal Model (needs creation):**
- id: INTEGER (Primary Key) - Unique goal identifier
- user_id: INTEGER - Foreign key to users table
- goal_type: VARCHAR(50) - Type of goal (daily_minutes, weekly_alignments, movie_completion)
- target_value: INTEGER - Target number to achieve
- current_value: INTEGER - Current progress toward target
- deadline: DATE - Goal deadline for completion
- created_at: DATETIME - Goal creation timestamp
- completed_at: DATETIME - Goal completion timestamp (nullable)
- is_active: BOOLEAN - Goal active status flag

**Frontend Dashboard Analytics Interface:**
```typescript
interface DashboardStats {
  total_study_minutes: number;
  movies_completed: number;
  total_alignments: number;
  current_streak: number;
  completion_rate: number;
  avg_session_duration: number;
  learning_velocity: number; // alignments per hour
}

interface LearningGoal {
  id: number;
  goal_type: string;
  target_value: number;
  current_value: number;
  progress_percentage: number;
  deadline: string;
  is_completed: boolean;
}

interface SessionHistoryEntry {
  date: string;
  movie_title: string;
  language_pair: string;
  duration_minutes: number;
  alignments_studied: number;
}
```

### Database Schema Requirements
[Source: architecture/database-schema.md]
**New Learning Goals Table:**
```sql
CREATE TABLE IF NOT EXISTS learning_goals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    goal_type VARCHAR(50) NOT NULL,
    target_value INTEGER NOT NULL,
    current_value INTEGER DEFAULT 0,
    deadline DATE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME,
    is_active BOOLEAN DEFAULT 1,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**Required Indexes for Analytics Performance:**
- `idx_goals_user_active` ON learning_goals(user_id, is_active)
- `idx_goals_type` ON learning_goals(goal_type)
- `idx_progress_streak` ON user_progress(user_id, last_accessed) for streak calculations
- `idx_progress_analytics` ON user_progress(user_id, last_accessed, session_duration_minutes)

### API Specifications Required
[Source: architecture/components.md#userdashboardservice]

**GET /api/progress/dashboard:**
- Returns comprehensive learning statistics including total minutes, completion rates
- Includes recent activity data with continue learning options
- Provides bookmark and favorite movies quick access data
- Requires user authentication and delivers personalized analytics data

**GET /api/progress/charts:**
- Delivers weekly and monthly progress data for Chart.js visualization
- Returns aggregated session data grouped by time periods
- Includes learning velocity trends and consistency metrics
- Supports date range parameters for custom chart periods

**GET /api/progress/streak:**
- Calculates consecutive learning days based on last_accessed timestamps
- Returns current streak length and streak history data
- Includes streak statistics like longest streak and streak patterns
- Handles timezone considerations for accurate daily calculations

**POST /api/goals and GET /api/goals:**
- CRUD operations for learning goals with validation and ownership
- Supports different goal types (daily_minutes, weekly_alignments, movie_completion)
- Returns goal progress calculations and completion status
- Includes automatic goal progress updates based on learning activity

### Frontend Component Architecture Required
[Source: architecture/unified-project-structure.md]

**Enhanced Dashboard Components:**
- `app/static/js/modules/dashboard-analytics.js` - Core analytics and charts functionality
- Chart.js integration for progress visualization and trend analysis
- Learning goals management interface with creation and progress tracking
- Session history timeline with detailed movie-language breakdowns
- Streak display components with visual achievement indicators

**Dashboard Template Enhancements:**
- `app/templates/main/dashboard.html` - Enhanced with goals section and charts
- Learning goals management modal for goal creation and editing
- Progress charts section with weekly/monthly visualization options
- Session history timeline with expandable movie details
- Quick access areas for bookmarks and favorite movies integration

**New Analytics Module:**
- `app/static/js/modules/session-analytics.js` - Session analysis and reporting
- Historical data visualization with trend analysis
- Learning velocity calculations and progress predictions
- Session comparison analytics and performance insights
- Exportable report generation for user learning summaries

### Backend Service Architecture Required
[Source: architecture/unified-project-structure.md]

**SessionAnalyticsService Class:**
- `app/services/session_analytics_service.py` - Analytics business logic implementation
- Methods: `calculate_streak()`, `generate_chart_data()`, `get_session_history()`, `calculate_learning_velocity()`
- Streak calculation with timezone handling and consecutive day logic
- Progress chart data generation for various time periods and metrics
- Session analytics with movie-language pair breakdowns and trends

**LearningGoalsService Class:**
- `app/services/learning_goals_service.py` - Goals management business logic
- Methods: `create_goal()`, `update_goal_progress()`, `get_user_goals()`, `check_goal_completion()`
- Automatic goal progress updates based on learning activity
- Goal completion detection and achievement notifications
- Goal validation and deadline management logic

**Enhanced Dashboard API Endpoints:**
- `app/blueprints/api/dashboard.py` - Comprehensive dashboard data endpoints
- User authentication validation using `@login_required` decorator
- Analytics data aggregation with performance optimization for Pi
- Chart data formatting for Chart.js compatibility
- Session history retrieval with pagination support

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]

**Backend Files:**
- Model: `app/models/learning_goal.py` - LearningGoal SQLAlchemy model (needs creation)
- Service: `app/services/session_analytics_service.py` - Analytics business logic
- Service: `app/services/learning_goals_service.py` - Goals management logic
- API: `app/blueprints/api/dashboard.py` - Enhanced dashboard endpoints
- Migration: `migrations/versions/xxx_add_learning_goals.py` - Goals table creation

**Frontend Files:**
- Module: `app/static/js/modules/dashboard-analytics.js` - Enhanced analytics functionality
- Module: `app/static/js/modules/session-analytics.js` - Session analysis and reporting
- Template: Enhanced `app/templates/main/dashboard.html` - Goals and charts sections
- Library: Chart.js CDN integration for progress visualization
- Component: Learning goals management modal and interface components

### Security Requirements
[Source: architecture/coding-standards.md#critical-fullstack-rules]
**Dashboard Analytics Security Controls:**
- **Authentication Validation**: All dashboard endpoints require `@login_required` decorator
- **Data Ownership**: Validate user owns analytics data before retrieval or display
- **Input Sanitization**: Validate goal parameters, date ranges, and chart parameters
- **Transaction Safety**: Use database transactions for goal creation and updates
- **Rate Limiting**: Prevent excessive analytics queries (max 100 requests/hour per user)
- **Session Security**: Never store sensitive analytics data in localStorage

### Performance Requirements
[Source: architecture/coding-standards.md#critical-fullstack-rules]
**Pi Resource Optimization for Dashboard:**
- **Memory-Conscious Queries**: Paginate session history (max 100 entries per request)
- **Database Optimization**: Use proper indexing for analytics queries by user and date ranges
- **Cache Analytics Data**: Cache computed statistics client-side with 5-minute expiration
- **Chart Optimization**: Limit chart data points to prevent performance issues (max 365 days)
- **Batch Analytics**: Compute multiple statistics in single database queries
- **Lazy Loading**: Load chart data only when chart sections are viewed

### Integration Points
**Existing Dashboard Integration (Current Template):**
- Extend existing DashboardProgress class with enhanced analytics
- Integrate Chart.js library for progress visualization
- Add goals management section to existing dashboard layout
- Connect with existing recent progress display for enhanced context

**Bookmark Integration (Story 3.4):**
- Quick access to bookmarked content from dashboard main view
- Recent bookmarks display in dashboard activity feed
- Bookmark statistics integration with learning analytics
- Navigation links to bookmark management from dashboard

**Progress Tracking Integration (Story 3.3):**
- Enhanced UserProgress data for comprehensive analytics
- Session duration analytics for learning velocity calculations
- Progress percentage calculations for completion rate statistics
- Learning session continuity tracking for streak calculations

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
**Backend Testing Requirements:**
- **Test File Location**: `tests/test_services/test_session_analytics_service.py`, `tests/test_services/test_learning_goals_service.py`, `tests/test_api/test_dashboard_endpoints.py`, `tests/test_models/test_learning_goal.py`
- **Test Framework**: pytest with fixtures for database setup and user authentication
- **Test Configuration**: SQLite in-memory database for isolated analytics testing

**Manual Testing Requirements:**
- **Test File Location**: All tests in `manual_tests/` directory organized by dashboard feature area
- **Test Framework**: Manual testing checklists for dashboard UI and analytics validation
- **Test Configuration**: Browser-based testing across desktop and mobile devices for charts

**Specific Testing Requirements for Story 3.5:**
- Test dashboard statistics calculations and accuracy across different data sets
- Test learning goals CRUD operations and automatic progress updates
- Test streak calculation accuracy including edge cases and timezone handling
- Test progress charts generation and Chart.js integration
- Test session analytics and historical data retrieval performance
- Test goals management interface and achievement notifications
- Test dashboard performance with large datasets and Pi resource constraints
- Test analytics API endpoints with authentication and data ownership validation

**Test Organization for This Story:**
```
tests/
├── test_models/
│   └── test_learning_goal.py           # LearningGoal model testing
├── test_services/
│   ├── test_session_analytics_service.py  # Analytics business logic testing
│   └── test_learning_goals_service.py     # Goals management testing
├── test_api/
│   └── test_dashboard_endpoints.py        # Dashboard API endpoint testing

manual_tests/
├── dashboard_analytics_checklist.md       # Analytics display and calculation testing
├── learning_goals_testing.md              # Goals management and tracking validation
├── progress_charts_testing.md             # Chart.js integration and visualization testing
└── session_analytics_testing.md           # Session history and analytics testing
```

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### File List
**Backend Files Created/Modified:**
- `app/models/learning_goal.py` - New LearningGoal model with progress tracking
- `app/services/learning_goals_service.py` - New service for goals CRUD and progress management
- `app/services/session_analytics_service.py` - New service for comprehensive learning analytics
- `app/blueprints/api/dashboard.py` - New dashboard API endpoints with comprehensive analytics
- `app/blueprints/api/__init__.py` - Updated to import dashboard endpoints
- `app/models/__init__.py` - Updated to include LearningGoal model
- `migrations/versions/d7c4d92be4dd_*.py` - Database migration for learning_goals table

**Frontend Files Created/Modified:**
- `app/templates/auth/dashboard.html` - Enhanced with analytics, goals management, and Chart.js integration
- `app/templates/base.html` - Added Chart.js CDN for visualization support
- `app/static/js/modules/dashboard-analytics.js` - New comprehensive analytics module
- `app/static/js/modules/session-analytics.js` - New session history and analytics module  
- `app/static/js/modules/goals-manager.js` - New goals management interface module

**Testing Files Created:**
- `tests/test_models/test_learning_goal.py` - Comprehensive LearningGoal model tests
- `tests/test_services/test_learning_goals_service.py` - LearningGoalsService test suite
- `tests/test_services/test_session_analytics_service.py` - SessionAnalyticsService test suite
- `tests/test_api/test_dashboard_endpoints.py` - Dashboard API endpoints test suite

### Completion Notes
- ✅ All 8 Acceptance Criteria fully implemented with comprehensive functionality
- ✅ Dashboard displays total study time, movies completed, and lines studied with enhanced analytics
- ✅ Recent activity showing with resume options and detailed session history
- ✅ Learning streak counter with consecutive days calculation
- ✅ Weekly/monthly progress charts using Chart.js with interactive visualization
- ✅ Personal learning statistics including velocity, completion rates, and session averages
- ✅ Quick access to bookmarked content integrated with existing bookmark functionality
- ✅ Learning goals system with creation, tracking, progress updates, and achievement notifications
- ✅ Session history with detailed movie-language breakdowns and comprehensive analytics
- ✅ Enhanced dashboard with modular JavaScript architecture and responsive design
- ✅ Comprehensive test coverage for all new models, services, and API endpoints
- ✅ Database migration successfully applied for learning_goals table
- ✅ All coding standards and Pi optimization requirements followed
- ✅ Chart.js integration with performance optimization for Pi resource constraints
- ✅ RESTful API design with consistent error handling and authentication

### Debug Log References
No critical issues encountered. All components implemented according to specifications with proper error handling and Pi resource optimization.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-19 | 1.0 | Initial story draft creation with comprehensive dashboard and session management requirements | Bob (SM Agent) |
| 2025-08-19 | 2.0 | Complete implementation of all acceptance criteria with enhanced dashboard, goals system, and comprehensive analytics | James (Dev Agent) |