# Story 4.1: API Client Setup & Authentication Integration

## Status
Draft

## Story
**As a** language learner using the React frontend,  
**I want** the application to connect to the Flask backend API with proper authentication,  
**so that** I can access my personal data, progress, and all learning features seamlessly.

## Acceptance Criteria
1. HTTP client infrastructure configured with React Query for server state management
2. Authentication state synchronized between React components and Flask session
3. Login/logout flows work seamlessly with existing Flask auth endpoints
4. API client handles authentication errors and token expiration gracefully
5. Loading states and error boundaries provide proper UX during API calls
6. CORS configuration enables secure cross-origin requests
7. All existing Flask API endpoints remain fully functional and accessible

## Tasks / Subtasks
- [ ] Set up HTTP Client Infrastructure (AC: 1, 6)
  - [ ] Configure axios as HTTP client with base URL and default headers
  - [ ] Set up request/response interceptors for authentication and error handling
  - [ ] Configure CORS settings to allow React frontend communication
  - [ ] Add request timeout and retry logic for network resilience
  - [ ] Implement proper TypeScript interfaces for API responses

- [ ] Configure React Query for Server State Management (AC: 1, 5)
  - [ ] Set up React Query client with optimized caching strategy
  - [ ] Configure query defaults for stale time and retry behavior
  - [ ] Add React Query DevTools for development debugging
  - [ ] Implement error boundaries for React Query failures
  - [ ] Set up loading state management for API calls

- [ ] Implement Authentication State Management (AC: 2, 3)
  - [ ] Create authentication context and hook for React components
  - [ ] Implement login API call with Flask session cookie handling
  - [ ] Implement logout API call with proper session cleanup
  - [ ] Add authentication state persistence using sessionStorage
  - [ ] Create protected route wrapper component for authenticated-only pages

- [ ] Handle Authentication Errors and Edge Cases (AC: 4, 5)
  - [ ] Implement 401 error handling with automatic redirect to login
  - [ ] Add session validation on app initialization
  - [ ] Handle network errors with proper user feedback
  - [ ] Implement request retry logic for temporary failures
  - [ ] Add offline detection and appropriate UX feedback

- [ ] Verify Flask API Integration (AC: 7)
  - [ ] Test all authentication endpoints (/auth/login, /auth/logout, /auth/register)
  - [ ] Verify session-based authentication works with React Query
  - [ ] Test CSRF token handling if required by Flask backend
  - [ ] Ensure existing Flask functionality remains intact
  - [ ] Test API client with real Flask backend running locally

- [ ] Create Comprehensive Testing Suite (Testing)
  - [ ] Unit tests for HTTP client configuration and interceptors
  - [ ] Unit tests for authentication hooks and context
  - [ ] Integration tests for login/logout flows
  - [ ] Error handling tests for network failures and auth errors
  - [ ] React Query mutation and query tests with mock API responses

## Dev Notes

### Previous Story Dependencies
From Story 3.5 (Learning Dashboard and Session Management):
- Complete Flask REST API with 20+ endpoints available for integration
- Authentication endpoints at `/auth/login`, `/auth/logout`, `/auth/register`
- Session-based authentication with Flask-Login established
- CORS configuration may need adjustment for React frontend integration
- Database and backend services fully functional and ready for frontend integration

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Framework**: React 18.x + Next.js 14.x with App Router for modern React development
- **Type Safety**: TypeScript 5.x for enhanced developer experience and fewer runtime errors
- **State Management - Server**: React Query (TanStack Query) 5.x for server state management and caching
- **State Management - Global**: Zustand 4.x for lightweight global state management
- **HTTP Client**: Axios or fetch API for HTTP communication with Flask backend
- **Package Manager**: npm for dependency management
- **Backend Framework**: Flask 2.3.x with existing session-based authentication
- **Authentication**: Flask-Login sessions with potential CSRF protection

### Data Models Required
[Source: architecture/data-models.md]
**User Authentication Interface:**
```typescript
interface User {
  id: number;
  email: string;
  oauth_provider?: 'google' | 'facebook' | 'apple' | null;
  oauth_id?: string;
  native_language_id: number;
  target_language_id: number;
  created_at: string;
  updated_at: string;
  is_active: boolean;
}

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
}

interface LoginRequest {
  email: string;
  password: string;
}

interface RegisterRequest {
  email: string;
  password: string;
  native_language_id: number;
  target_language_id: number;
}
```

### API Specifications Required
[Source: architecture/api-specification.md]
**Authentication Endpoints:**
- `POST /auth/login` - User login with session creation, expects email/password, returns user data
- `POST /auth/register` - User registration with language preferences
- `POST /auth/logout` - Session cleanup and logout
- `GET /auth/me` - Get current user info (may need to be implemented)

**Response Formats:**
- Success responses: `{ success: true, data: {...}, message: "..." }`
- Error responses: `{ success: false, error: "message", code: "error_type" }`
- Authentication: Session cookie based, name: "session"

### Frontend Component Architecture Required
[Source: architecture/frontend-architecture.md]
**HTTP Client Setup:**
- `lib/api.ts` - Centralized API client with axios configuration
- Base URL configuration for development and production environments
- Request/response interceptors for authentication and error handling
- TypeScript interfaces for all API request/response types

**Authentication Architecture:**
- `lib/auth.ts` - Authentication utilities and API calls
- `hooks/useAuth.ts` - Authentication state hook for React components
- `contexts/AuthContext.tsx` - Authentication context provider
- `components/auth/ProtectedRoute.tsx` - Route protection wrapper

**React Query Integration:**
- `lib/queryClient.ts` - React Query client configuration
- Default stale time: 5 minutes for cached data
- Retry logic: 3 attempts for failed requests
- Cache invalidation patterns for authentication state changes

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
**New Frontend Files to Create:**
- `lib/api.ts` - HTTP client configuration and base API setup
- `lib/auth.ts` - Authentication utilities and API integration
- `lib/queryClient.ts` - React Query client configuration
- `hooks/useAuth.ts` - Authentication state management hook
- `contexts/AuthContext.tsx` - Authentication context provider
- `components/auth/ProtectedRoute.tsx` - Route protection component
- `types/api.ts` - TypeScript interfaces for API requests/responses
- `types/auth.ts` - Authentication-related TypeScript interfaces

**Existing Files to Modify:**
- `app/layout.tsx` - Add React Query provider and authentication context
- `package.json` - Add dependencies for axios, React Query, and related packages
- `next.config.js` - Configure API proxy if needed for development

### Security Requirements
[Source: architecture/coding-standards.md#critical-fullstack-rules]
**Authentication Security Controls:**
- **Session Security**: Use secure, httpOnly session cookies for authentication state
- **CORS Configuration**: Properly configure CORS headers for React frontend communication
- **Input Sanitization**: Validate all authentication inputs on both frontend and backend
- **Error Handling**: Never expose sensitive error details in client-side error messages
- **Session Management**: Implement proper session cleanup on logout and browser close
- **CSRF Protection**: Handle CSRF tokens if required by Flask backend configuration

### Performance Requirements
[Source: architecture/coding-standards.md#critical-fullstack-rules]
**API Client Optimization:**
- **Request Timeout**: 30 seconds for authentication requests, 10 seconds for other API calls
- **Retry Logic**: Maximum 3 retry attempts with exponential backoff
- **Cache Strategy**: 5-minute stale time for user data, immediate invalidation on auth changes
- **Bundle Size**: Keep HTTP client dependencies minimal for optimal loading
- **Connection Management**: Reuse HTTP connections and implement proper connection pooling
- **Error Recovery**: Graceful degradation when backend is temporarily unavailable

### Integration Points
**Flask Backend Integration:**
- All existing Flask authentication endpoints must remain unchanged
- Session cookie handling must work seamlessly with Flask-Login
- CORS headers must be properly configured on Flask backend
- Error response format should match existing Flask API patterns

**React Query Integration:**
- Authentication state should trigger cache invalidation for protected data
- Loading states should be consistent across all API calls
- Error handling should be centralized and user-friendly
- Optimistic updates should be used where appropriate for better UX

**Next.js Integration:**
- API client should work with both client-side and server-side rendering
- Environment variables for API base URL configuration
- Proper error boundaries for API failures during SSR
- Authentication state should persist across page refreshes

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
**Frontend Testing Requirements:**
- **Test Framework**: Jest + React Testing Library for component and hook testing
- **E2E Testing**: Manual testing checklists for authentication flows
- **Test Configuration**: Mock API responses for isolated testing

**Specific Testing Requirements for Story 4.1:**
- Test HTTP client configuration and interceptor behavior
- Test authentication context provider and useAuth hook
- Test login/logout flows with mock Flask API responses
- Test error handling for network failures and authentication errors
- Test protected route component behavior for authenticated/unauthenticated states
- Test React Query integration with authentication state changes
- Manual testing of actual Flask backend integration

**Test Organization for This Story:**
```
src/
├── __tests__/
│   ├── lib/
│   │   ├── api.test.ts                 # HTTP client testing
│   │   └── auth.test.ts                # Authentication utilities testing
│   ├── hooks/
│   │   └── useAuth.test.ts             # Authentication hook testing
│   ├── contexts/
│   │   └── AuthContext.test.tsx        # Authentication context testing
│   └── components/
│       └── auth/
│           └── ProtectedRoute.test.tsx # Route protection testing

manual_tests/
├── authentication_flows.md            # Manual login/logout testing
├── api_integration_checklist.md       # Flask backend integration validation
└── error_handling_scenarios.md        # Network and auth error testing
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-20 | 1.0 | Initial story draft creation for API client setup and authentication integration | Bob (SM Agent) |