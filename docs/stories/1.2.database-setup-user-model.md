# Story 1.2: Database Setup and User Model

## Status
Draft

## Story
**As a** system administrator,  
**I want** the database schema and user model established,  
**so that** user data can be stored securely and efficiently.

## Acceptance Criteria
1. SQLite database configuration with Flask-SQLAlchemy integration
2. User model defined with fields: id, email, password_hash, oauth_provider, oauth_id, created_at, updated_at
3. Database migration system configured using Flask-Migrate
4. Initial migration created and tested for user table creation
5. Database initialization script created for development setup
6. Basic database connection testing endpoint available
7. Password hashing implemented using secure algorithms (bcrypt/werkzeug)

## Tasks / Subtasks
- [ ] Configure SQLite Database Integration (AC: 1)
  - [ ] Install Flask-SQLAlchemy and configure in app factory
  - [ ] Configure SQLite database URL in config.py
  - [ ] Add database initialization to Flask application
  - [ ] Verify database connection in app startup
- [ ] Create User Model with SQLAlchemy (AC: 2, 7)
  - [ ] Create `app/models/user.py` with User model class
  - [ ] Define required fields: id, email, password_hash, oauth_provider, oauth_id, timestamps
  - [ ] Add password hashing methods using Werkzeug security
  - [ ] Add model validation for email uniqueness
  - [ ] Include __repr__ method for debugging
- [ ] Configure Flask-Migrate for Database Migrations (AC: 3, 4)
  - [ ] Install and configure Flask-Migrate in app factory
  - [ ] Initialize migration repository with `flask db init`
  - [ ] Create initial migration for user table with `flask db migrate`
  - [ ] Test migration execution with `flask db upgrade`
  - [ ] Verify user table creation in SQLite database
- [ ] Create Database Initialization Script (AC: 5)
  - [ ] Create `scripts/init_db.py` for database setup
  - [ ] Include database creation and migration execution
  - [ ] Add sample data insertion for testing
  - [ ] Make script executable and test execution
- [ ] Add Database Connection Testing Endpoint (AC: 6)
  - [ ] Create database health check route in main blueprint
  - [ ] Test database connectivity and table existence
  - [ ] Return JSON response with database status
  - [ ] Include in main health check endpoint
- [ ] Create Database Utility Functions (Supporting)
  - [ ] Create `app/utils/database.py` with helper functions
  - [ ] Add database connection testing utilities
  - [ ] Include query optimization helpers for SQLite
  - [ ] Add error handling for database operations

## Dev Notes

### Previous Story Insights
From Story 1.1:
- Flask application factory pattern is established in `app/__init__.py`
- Configuration system is available in `app/config.py` with environment variable support
- Project structure follows unified architecture specifications exactly
- Error handling system is configured in `app/utils/error_handlers.py`

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Database**: SQLite 3.x for all data storage (users, subtitles, progress)
- **Backend Framework**: Flask 2.3.x with Flask-SQLAlchemy for ORM
- **Backend Language**: Python 3.9+ for server-side application logic
- **Cache**: SQLite WAL mode built-in for query performance optimization

### Data Model Specifications
[Source: architecture/data-models.md]
User model must include these exact attributes:
- id: INTEGER (Primary Key) - Unique user identifier
- email: VARCHAR(255) - User's email address for login
- password_hash: VARCHAR(255) - Securely hashed password
- oauth_provider: VARCHAR(50) - OAuth provider (google, facebook, apple, null)
- oauth_id: VARCHAR(255) - OAuth provider user ID
- created_at: DATETIME - Account creation timestamp
- updated_at: DATETIME - Last profile update timestamp
- is_active: BOOLEAN - Account status flag

### Database Schema Requirements
[Source: architecture/database-schema.md]
Exact SQL schema for users table:
```sql
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT,
    oauth_provider TEXT,
    oauth_provider TEXT,
    oauth_id TEXT,
    native_language_id SMALLINT,
    target_language_id SMALLINT,
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (native_language_id) REFERENCES languages(id),
    FOREIGN KEY (target_language_id) REFERENCES languages(id),
    UNIQUE(oauth_provider, oauth_id)
);
```

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
- User model: `app/models/user.py`
- Database utilities: `app/utils/database.py`
- Migration files: `migrations/versions/`
- Database initialization script: `scripts/init_db.py`
- Instance-specific database file: `instance/subtitle_database.db`

### Coding Standards
[Source: architecture/coding-standards.md]
- **Database Connection Management**: Always use SQLAlchemy context managers or Flask-SQLAlchemy's db.session, never create raw SQLite connections
- **SQLAlchemy Models**: Use PascalCase (e.g., `UserProgress`, `SubLinkLine`)
- **Python Functions**: Use snake_case (e.g., `create_user()`, `hash_password()`)
- **Environment Variables**: Use UPPER_SNAKE_CASE (e.g., `DATABASE_URL`)

### Required Dependencies
[Source: architecture/tech-stack.md]
Additional requirements for requirements.txt:
- Flask-SQLAlchemy (latest compatible with Flask 2.3.x)
- Flask-Migrate (for database migrations)
- Werkzeug (for password hashing, included with Flask)

### File Locations for New Code
[Source: architecture/unified-project-structure.md]
- User model: `app/models/user.py`
- Database utilities: `app/utils/database.py`
- Database initialization script: `scripts/init_db.py`
- Migration configuration: `migrations/alembic.ini`
- Database file: `instance/subtitle_database.db`

### SQLite Optimization Requirements
[Source: architecture/database-schema.md]
Required SQLite optimizations:
```sql
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = 10000;
PRAGMA temp_store = memory;
PRAGMA mmap_size = 268435456; -- 256MB
```

### Technical Constraints
[Source: architecture/tech-stack.md]
- Pi resource optimization: Lightweight components only
- Local filesystem storage: No cloud dependencies
- SQLite for all data storage: Single-file database
- Memory-conscious operations to prevent Pi system crashes

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test File Location**: All tests in `tests/` directory
- **Test Framework**: pytest 7.x for backend unit and integration testing
- **Test Configuration**: Use `tests/conftest.py` for pytest configuration and fixtures
- **Test Organization**: Organize tests by component type (models, services, api, integration)
- **Specific Requirements for This Story**:
  - Test User model creation and validation
  - Test password hashing and verification methods
  - Test database connection and migration execution
  - Test database initialization script functionality
  - Test database health check endpoint
  - Test SQLite optimization settings application

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
*This section will be populated by the QA agent after story implementation*