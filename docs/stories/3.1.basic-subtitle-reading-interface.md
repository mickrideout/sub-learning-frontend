# Story 3.1: Basic Subtitle Reading Interface

## Status
Draft

## Story
**As a** language learner,  
**I want** to view movie subtitles in both my native and target languages side-by-side,  
**so that** I can study language connections through authentic movie content.

## Acceptance Criteria
1. Split-screen layout displaying subtitles in two columns (native language | target language)
2. Subtitle lines synchronized between both languages showing corresponding translations
3. Adjustable column widths allowing users to customize reading layout preferences
4. Clear visual separation between language columns with appropriate spacing
5. Font size controls for optimal reading comfort across different screen sizes
6. Navigation controls to move between subtitle lines (previous/next buttons)
7. Current subtitle line highlighted or emphasized for reading focus
8. Responsive design ensuring readability on desktop and mobile devices

## Tasks / Subtasks
- [ ] Create Learning Interface Template and Route (AC: 1, 8)
  - [ ] Add `/learning/<sub_link_id>` route to main blueprint (`app/blueprints/main/routes.py`)
  - [ ] Create `learning.html` template with split-screen Bootstrap layout
  - [ ] Implement responsive CSS for desktop and mobile layouts
  - [ ] Add navigation structure and component placeholders

- [ ] Build Dual Subtitle Display Component (AC: 1, 2, 4)
  - [ ] Create `dual-subtitle-display.js` component in `app/static/js/components/`
  - [ ] Implement side-by-side subtitle rendering with Bootstrap grid system
  - [ ] Add visual separation styling between language columns
  - [ ] Handle alignment synchronization between source and target lines

- [ ] Implement Subtitle Data Loading System (AC: 2)
  - [ ] Create API endpoint for alignment retrieval in `app/blueprints/api/subtitles.py`
  - [ ] Implement pagination for alignment data (max 50 alignments per request)
  - [ ] Add error handling for missing or corrupted alignment data
  - [ ] Integrate with existing subtitle service for content delivery

- [ ] Add Layout Customization Controls (AC: 3, 5)
  - [ ] Implement adjustable column width controls with JavaScript
  - [ ] Add font size adjustment controls (small, medium, large, extra-large)
  - [ ] Save user preferences to localStorage for persistence
  - [ ] Apply responsive breakpoints for mobile device optimization

- [ ] Implement Navigation Controls (AC: 6, 7)
  - [ ] Add previous/next buttons with keyboard shortcuts (arrow keys)
  - [ ] Implement current alignment highlighting with CSS emphasis
  - [ ] Add progress indicator showing current position in subtitle sequence
  - [ ] Handle boundary conditions (first/last alignment navigation)

- [ ] Integrate with Progress Tracking System (Integration)
  - [ ] Load user's current progress position for sub_link_id
  - [ ] Update progress automatically when user navigates between alignments
  - [ ] Handle session resumption from last accessed alignment
  - [ ] Ensure compatibility with existing UserProgress model

- [ ] Create Learning Interface Tests (Testing)
  - [ ] Test split-screen layout rendering on various screen sizes
  - [ ] Test subtitle alignment synchronization and data loading
  - [ ] Test navigation controls and keyboard shortcuts functionality
  - [ ] Test customization controls (font size, column width)
  - [ ] Test integration with progress tracking and session management

## Dev Notes

### Previous Story Dependencies
From Story 2.5 (Subtitle Database Retrieval System):
- Subtitle retrieval API endpoints `/api/movies/{movie_id}/subtitles` available
- SubLine database model implemented with content and sequence data
- Caching system operational for subtitle content retrieval
- Error handling patterns established for missing subtitle data
- Integration with movie catalog and language pair filtering complete

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Framework**: Vanilla JavaScript (ES6+) with Bootstrap 5.3 for responsive layout
- **Backend Framework**: Flask 2.3.x with blueprint routing for learning interface
- **Database**: SQLite with existing SubLinkLine table for alignment data
- **State Management**: Browser SessionStorage/LocalStorage for user preferences
- **UI Components**: Bootstrap grid system for split-screen layout
- **CSS Framework**: Bootstrap + Custom CSS for subtitle reading optimization

### Data Models Available
[Source: architecture/data-models.md]
**SubLinkLine Structure:**
- sub_link_id: INTEGER - Links to specific translation pair
- link_data: JSONB - Array of aligned line pairs `[[source_line_ids], [target_line_ids]]`

**SubLine Structure:**
- id: INTEGER - Unique subtitle line identifier
- lineid: SMALLINT - Sequential line number for ordering
- content: TEXT - Subtitle text content for display

**UserProgress Structure:**
- user_id: INTEGER - User identifier
- sub_link_id: INTEGER - Translation pair being studied
- current_alignment_index: INTEGER - Current position in link_data array
- last_accessed: DATETIME - Session resumption timestamp

### API Specifications Required
[Source: architecture/frontend-architecture.md, architecture/data-models.md]
**Learning Interface Endpoints:**
- `GET /learning/{sub_link_id}` - Main learning interface page
- `GET /api/subtitles/{sub_link_id}?start_index={n}&limit=50` - Paginated alignment data
  - Parameters: start_index (current position), limit (max 50 alignments)
  - Response: Array of alignment objects with source_lines and target_lines
  - Includes pagination metadata (total_alignments, current_index)

**Progress Integration Endpoints:**
- `GET /api/progress/{sub_link_id}` - Retrieve current user progress
- `PUT /api/progress/{sub_link_id}` - Update progress during navigation

### Frontend Component Specifications
[Source: architecture/frontend-architecture.md, architecture/components.md]
**SubtitlePlayer Component Structure:**
- Constructor accepts subLinkId and startIndex parameters
- Loads alignment data with pagination (50 alignments per batch)
- Renders dual-language display with Bootstrap responsive columns
- Manages navigation state and progress updates
- Handles keyboard shortcuts (arrow keys, spacebar)

**DualSubtitleDisplay Component:**
- Renders source and target language columns with Bootstrap grid
- Synchronizes alignment display between languages
- Applies user customization preferences (font size, column width)
- Handles responsive breakpoints for mobile optimization

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
**New Learning Interface Files:**
- Template: `app/templates/main/learning.html` - Main learning interface page
- Route: `app/blueprints/main/routes.py` - Add `/learning/<sub_link_id>` route
- Component: `app/static/js/components/dual-subtitle-display.js` - Dual subtitle rendering
- Module: `app/static/js/modules/subtitle-player.js` - Core learning interface logic
- Styles: `app/static/css/learning.css` - Subtitle display and layout optimizations

### Security Requirements
[Source: architecture/coding-standards.md]
**Critical Security Rules:**
- **Session Security**: Validate user authentication before displaying learning content
- **Input Sanitization**: Escape subtitle content in Jinja2 templates to prevent XSS
- **Access Control**: Verify user has access to requested sub_link_id language pair
- **State Management**: Use Flask sessions for authentication, localStorage only for preferences
- **Progress Tracking Atomicity**: Use database transactions for progress updates

### Form Validation Requirements
[Source: architecture/coding-standards.md]
**Learning Interface Validation:**
- sub_link_id must be valid integer and exist in sub_links table
- User must have access to the specific language pair (fromlang/tolang)
- Alignment index must be within bounds of available link_data array
- Font size and column width preferences must be within acceptable ranges

### Core Workflow Integration
[Source: architecture/core-workflows.md#dual-language-subtitle-learning-session]
**Learning Session Workflow:**
1. User navigates from movie catalog to `/learning/{sub_link_id}` route
2. System loads link_data from SubLinkLine table for the translation pair
3. User's current progress retrieved from UserProgress table (current_alignment_index)
4. First batch of alignments (50) loaded with subtitle content from SubLine table
5. Dual-language interface displays synchronized source and target subtitle lines
6. Navigation updates progress automatically and loads additional alignments as needed

**State Management Workflow:**
- Current alignment index tracked in browser memory for immediate navigation
- Progress updates sent to server every 5 alignment advances or session change
- User preferences (font size, column width) persisted in localStorage
- Session resumption loads last accessed alignment from UserProgress table

### Memory Management Requirements
[Source: architecture/coding-standards.md]
**Pi Resource Optimization:**
- Load maximum 50 alignments per API request to prevent memory exhaustion
- Cache subtitle content with TTL to balance performance and memory usage
- Use pagination for large subtitle files to maintain responsive performance
- Monitor client-side memory usage and implement cleanup for long sessions

### Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test File Location**: All tests in `tests/` directory with organized subdirectories
- **Test Framework**: Manual testing for frontend components due to resource constraints
- **Test Configuration**: Use manual testing checklists for UI validation
- **Test Organization**: Manual UI, responsive, and integration testing approaches

**Specific Requirements for Basic Subtitle Reading Interface Story**:
- Test split-screen layout rendering across desktop, tablet, and mobile screen sizes
- Test dual-language subtitle synchronization with various alignment data patterns
- Test navigation controls including keyboard shortcuts and boundary conditions
- Test customization features (font size, column width) and localStorage persistence
- Test integration with progress tracking and session resumption functionality
- Test error handling for missing alignments and network connectivity issues

**Test Organization for This Story**:
```
manual_tests/
├── learning_interface_checklist.md     # Split-screen layout and navigation tests
├── responsive_subtitle_display.md      # Mobile/tablet subtitle readability tests
├── customization_features.md           # Font size and column width testing
└── progress_integration_tests.md       # Session management and progress tracking tests
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-19 | 1.0 | Initial story draft creation | Claude Sonnet 4 |