{% extends "base.html" %}

{% block title %}Dashboard - Sub Learning{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Welcome, {{ user.email }}!</h1>
            <div>
                <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-primary me-2">View Profile</a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary">Logout</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Account Status</h5>
                <p class="card-text">
                    {% if user.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                </p>
                <p class="card-text">
                    <small class="text-muted">Member since {{ user.created_at.strftime('%B %Y') if user.created_at else 'N/A' }}</small>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Learning Progress</h5>
                <div id="overall-progress-stats">
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="overall-progress-bar"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Total Progress</span>
                        <span id="overall-progress-text">0%</span>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col">
                            <h6 class="mb-1" id="movies-studied">0</h6>
                            <small class="text-muted">Movies Studied</small>
                        </div>
                        <div class="col">
                            <h6 class="mb-1" id="total-minutes">0</h6>
                            <small class="text-muted">Minutes Learned</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Quick Actions</h5>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-primary btn-sm">View Profile</a>
                    <a href="{{ url_for('main.movies') }}" class="btn btn-success btn-sm">Browse Movies</a>
                    <a href="{{ url_for('main.bookmarks') }}" class="btn btn-warning btn-sm">
                        <i class="fas fa-bookmark me-1"></i>My Bookmarks
                    </a>
                </div>
                <p class="card-text">
                    <small class="text-muted">More features coming soon</small>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Recently Studied Movies
                    <button class="btn btn-outline-secondary btn-sm" id="refresh-recent" title="Refresh recent progress">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </h5>
                <div id="recent-progress-container">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status" id="recent-progress-loader">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading recent progress...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Learning Analytics
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" id="toggle-goals">
                            <i class="fas fa-target"></i> Goals
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="refresh-analytics">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </h5>
                
                <!-- Enhanced Analytics Stats -->
                <div id="learning-analytics">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-primary mb-1" id="total-alignments-completed">0</h4>
                            <small class="text-muted">Alignments Completed</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-success mb-1" id="current-streak">0</h4>
                            <small class="text-muted">Day Streak</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-info mb-1" id="avg-session-time">0</h4>
                            <small class="text-muted">Avg. Session (min)</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-warning mb-1" id="completion-rate">0%</h4>
                            <small class="text-muted">Completion Rate</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-secondary mb-1" id="learning-velocity">0.0</h4>
                            <small class="text-muted">Alignments/Hour</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-dark mb-1" id="active-sessions">0</h4>
                            <small class="text-muted">Active Sessions</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-primary mb-1" id="movies-completed">0</h4>
                            <small class="text-muted">Movies Completed</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <h4 class="text-success mb-1" id="total-study-time">0</h4>
                            <small class="text-muted">Total Hours</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Charts Section -->
                <div class="mt-4">
                    <h6 class="mb-3">Learning Progress Charts</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="btn-group btn-group-sm" role="group" id="chart-period-toggle">
                                    <input type="radio" class="btn-check" name="chart-period" id="period-weekly" value="weekly" checked>
                                    <label class="btn btn-outline-primary" for="period-weekly">Weekly</label>
                                    
                                    <input type="radio" class="btn-check" name="chart-period" id="period-monthly" value="monthly">
                                    <label class="btn btn-outline-primary" for="period-monthly">Monthly</label>
                                </div>
                                <small class="text-muted">Last 30 days</small>
                            </div>
                            <div style="height: 300px; position: relative;">
                                <canvas id="progress-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Learning Goals Section -->
<div class="row" id="goals-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="card-title mb-0">Learning Goals</h5>
                    <button class="btn btn-primary btn-sm" id="create-goal-btn">
                        <i class="fas fa-plus"></i> Create Goal
                    </button>
                </div>
                
                <div id="goals-container">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status" id="goals-loader">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading goals...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session History Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Session History
                    <button class="btn btn-outline-secondary btn-sm" id="refresh-history">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </h5>
                
                <div id="session-history-container">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status" id="history-loader">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading session history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Goal Creation Modal -->
<div class="modal fade" id="goalModal" tabindex="-1" aria-labelledby="goalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="goalModalLabel">Create Learning Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="goal-form">
                    <div class="mb-3">
                        <label for="goal-type" class="form-label">Goal Type</label>
                        <select class="form-select" id="goal-type" required>
                            <option value="">Select goal type...</option>
                            <option value="daily_minutes">Daily Minutes</option>
                            <option value="weekly_alignments">Weekly Alignments</option>
                            <option value="movie_completion">Movie Completion</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="target-value" class="form-label">Target Value</label>
                        <input type="number" class="form-control" id="target-value" min="1" required>
                        <div class="form-text" id="target-help">Enter the target number for your goal.</div>
                    </div>
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Deadline (Optional)</label>
                        <input type="date" class="form-control" id="deadline">
                        <div class="form-text">Set a deadline to track your progress.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-goal">Create Goal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
import { DashboardAnalytics } from '/static/js/modules/dashboard-analytics.js';
import { SessionAnalytics } from '/static/js/modules/session-analytics.js';
import { GoalsManager } from '/static/js/modules/goals-manager.js';
import { StorageHelper } from '/static/js/utils/storage-helper.js';

class EnhancedDashboard {
    constructor() {
        this.recentProgressData = [];
        this.dashboardAnalytics = null;
        this.sessionAnalytics = null;
        this.goalsManager = null;
        this.goalsVisible = false;
        
        this.init();
    }
    
    async init() {
        console.log('Enhanced Dashboard initializing...');
        
        // Initialize all dashboard modules
        this.dashboardAnalytics = new DashboardAnalytics();
        this.sessionAnalytics = new SessionAnalytics();
        this.goalsManager = new GoalsManager();
        
        // Load recent progress (legacy functionality)
        await this.loadRecentProgress();
        this.bindEvents();
        
        console.log('Enhanced Dashboard initialized');
    }
    
    async loadRecentProgress() {
        try {
            const response = await fetch('/api/progress/recent?limit=10', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            if (response.ok) {
                const data = await response.json();
                this.recentProgressData = data.recent_progress || [];
                this.updateRecentProgressDisplay();
            } else if (response.status === 404 || this.recentProgressData.length === 0) {
                this.showNoProgressMessage();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
            
        } catch (error) {
            console.error('Failed to load recent progress:', error);
            this.showErrorMessage('Unable to load progress data');
        } finally {
            this.hideLoader();
        }
    }
    
    updateRecentProgressDisplay() {
        const container = document.getElementById('recent-progress-container');
        if (!container) return;
        
        if (this.recentProgressData.length === 0) {
            this.showNoProgressMessage();
            return;
        }
        
        const html = this.recentProgressData.map(progress => {
            const completionBadge = progress.completion_percentage >= 100 
                ? '<span class="badge bg-success ms-2">Complete</span>'
                : `<span class="badge bg-primary ms-2">${Math.round(progress.completion_percentage)}%</span>`;
            
            const lastAccessed = new Date(progress.last_accessed).toLocaleDateString();
            
            return `
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Subtitle Link #${progress.sub_link_id}</h6>
                        ${completionBadge}
                    </div>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-success" 
                             style="width: ${progress.completion_percentage}%" 
                             role="progressbar"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Position: ${progress.current_alignment_index + 1} / ${progress.total_alignments}</span>
                        <span>Last studied: ${lastAccessed}</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Session time: ${progress.session_duration_minutes || 0} minutes</span>
                        <a href="/learn/${progress.sub_link_id}" class="btn btn-sm btn-outline-primary">
                            ${progress.completion_percentage >= 100 ? 'Review' : 'Continue'}
                        </a>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
    
    showNoProgressMessage() {
        const container = document.getElementById('recent-progress-container');
        if (!container) return;
        
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No Learning Progress Yet</h6>
                <p class="text-muted mb-3">Start learning by selecting a movie and studying subtitles!</p>
                <a href="/movies" class="btn btn-primary btn-sm">Browse Movies</a>
            </div>
        `;
    }
    
    showErrorMessage(message) {
        const container = document.getElementById('recent-progress-container');
        if (!container) return;
        
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <p class="text-muted">${message}</p>
                <button class="btn btn-outline-primary btn-sm" onclick="window.location.reload()">
                    Try Again
                </button>
            </div>
        `;
    }
    
    hideLoader() {
        const loader = document.getElementById('recent-progress-loader');
        if (loader && loader.parentElement) {
            loader.parentElement.style.display = 'none';
        }
    }
    
    bindEvents() {
        // Refresh recent progress button
        const refreshBtn = document.getElementById('refresh-recent');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                refreshBtn.disabled = true;
                const icon = refreshBtn.querySelector('i');
                if (icon) icon.classList.add('fa-spin');
                
                await this.loadRecentProgress();
                
                refreshBtn.disabled = false;
                if (icon) icon.classList.remove('fa-spin');
            });
        }
        
        // Toggle goals section
        const toggleGoalsBtn = document.getElementById('toggle-goals');
        if (toggleGoalsBtn) {
            toggleGoalsBtn.addEventListener('click', () => {
                this.toggleGoalsSection();
            });
        }
    }
    
    toggleGoalsSection() {
        const goalsSection = document.getElementById('goals-section');
        const toggleBtn = document.getElementById('toggle-goals');
        
        if (goalsSection && toggleBtn) {
            this.goalsVisible = !this.goalsVisible;
            goalsSection.style.display = this.goalsVisible ? 'block' : 'none';
            
            // Update button text
            const icon = toggleBtn.querySelector('i');
            if (icon) {
                icon.className = this.goalsVisible ? 'fas fa-eye-slash' : 'fas fa-target';
            }
            
            // Update button text
            toggleBtn.innerHTML = this.goalsVisible 
                ? '<i class="fas fa-eye-slash"></i> Hide Goals' 
                : '<i class="fas fa-target"></i> Goals';
        }
    }
    
    async refreshAll() {
        // Refresh all dashboard data
        await this.loadRecentProgress();
        
        if (this.dashboardAnalytics) {
            await this.dashboardAnalytics.refreshAll();
        }
        
        if (this.sessionAnalytics) {
            await this.sessionAnalytics.refreshHistory();
        }
        
        if (this.goalsManager && this.goalsVisible) {
            await this.goalsManager.loadGoals();
        }
    }
}

// Global variables for module access
let dashboard;
let goalsManager;

// Initialize enhanced dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    dashboard = new EnhancedDashboard();
    
    // Make goals manager globally accessible for onclick handlers
    setTimeout(() => {
        goalsManager = dashboard.goalsManager;
    }, 100);
});
</script>
{% endblock %}