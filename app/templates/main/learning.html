{% extends "base.html" %}

{% block title %}Learning Interface - Sub Learning{% endblock %}

{% block content %}
<div class="learning-container">
    <!-- Header Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Learning Interface</h2>
                <div class="controls-group">
                    <!-- Font Size Controls -->
                    <div class="btn-group me-3" role="group" aria-label="Font size controls">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="font-small">
                            <i class="fas fa-font" style="font-size: 0.8em;"></i> S
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="font-medium">
                            <i class="fas fa-font"></i> M
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm active" id="font-large">
                            <i class="fas fa-font" style="font-size: 1.2em;"></i> L
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="font-xlarge">
                            <i class="fas fa-font" style="font-size: 1.4em;"></i> XL
                        </button>
                    </div>
                    
                    <!-- Column Width Controls -->
                    <div class="btn-group me-3" role="group" aria-label="Column width controls">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="width-equal">
                            <i class="fas fa-columns"></i> Equal
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="width-left">
                            <i class="fas fa-arrow-left"></i> Left
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="width-right">
                            <i class="fas fa-arrow-right"></i> Right
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Progress Indicator -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="progress-container">
                <div class="progress clickable-progress" role="button" tabindex="0" aria-label="Click to navigate">
                    <div class="progress-bar" role="progressbar" style="width: 0%" 
                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progress-bar">
                        <span id="progress-text">0 / 0</span>
                    </div>
                </div>
                <div class="progress-details d-flex justify-content-between mt-1">
                    <small class="text-muted" id="progress-percentage">0%</small>
                    <small class="text-muted" id="progress-time">Estimated time: --</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Playback Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-center align-items-center flex-wrap">
                <!-- Auto-play Controls -->
                <div class="btn-group me-3 mb-2" role="group" aria-label="Playback controls">
                    <button type="button" class="btn btn-success" id="btn-play-pause">
                        <i class="fas fa-play"></i> <span class="btn-text">Play</span>
                    </button>
                </div>
                
                <!-- Speed Selection -->
                <div class="me-3 mb-2">
                    <label for="speed-selector" class="form-label mb-0 me-2">Speed:</label>
                    <select class="form-select form-select-sm" id="speed-selector" style="width: auto; display: inline-block;">
                        <option value="1000">Fast (1s)</option>
                        <option value="3000" selected>Normal (3s)</option>
                        <option value="5000">Slow (5s)</option>
                    </select>
                </div>
                
                <!-- Manual Navigation Controls -->
                <div class="btn-group me-3 mb-2" role="group" aria-label="Manual navigation">
                    <button type="button" class="btn btn-outline-secondary" id="btn-first">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-prev" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-next" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="btn-last">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <!-- Keyboard Shortcuts Help -->
                <button type="button" class="btn btn-outline-info btn-sm mb-2" id="btn-shortcuts" title="Keyboard Shortcuts">
                    <i class="fas fa-keyboard"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Split-screen Subtitle Display -->
    <div class="row">
        <div class="col-12">
            <div class="dual-subtitle-container">
                <div class="row" id="subtitle-row">
                    <div class="col-md-6" id="source-column">
                        <div class="subtitle-panel">
                            <h5 class="panel-title" id="source-lang-title">Source Language</h5>
                            <div class="subtitle-content" id="source-content">
                                <div class="subtitle-line-placeholder">
                                    Loading subtitle content...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6" id="target-column">
                        <div class="subtitle-panel">
                            <h5 class="panel-title" id="target-lang-title">Target Language</h5>
                            <div class="subtitle-content" id="target-content">
                                <div class="subtitle-line-placeholder">
                                    Loading subtitle content...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div class="row mt-3" id="error-container" style="display: none;">
        <div class="col-12">
            <div class="alert alert-danger" role="alert" id="error-message">
                An error occurred while loading subtitle data.
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="row mt-3" id="loading-container">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading subtitle data...</p>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="learning-data">
{
    "subLinkId": {{ sub_link_id }},
    "fromLang": {{ sub_link.fromlang }},
    "toLang": {{ sub_link.tolang }}
}
</script>
{% endblock %}

{% block scripts %}
<link href="{{ url_for('static', filename='css/learning.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/utils/storage-helper.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/dual-subtitle-display.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/subtitle-player.js') }}"></script>
<script>
    // Initialize learning interface when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const learningData = JSON.parse(document.getElementById('learning-data').textContent);
        
        // Initialize subtitle player
        const subtitlePlayer = new SubtitlePlayer(learningData.subLinkId, 0);
        
        // Set up additional UI event listeners
        const btnFirst = document.getElementById('btn-first');
        const btnLast = document.getElementById('btn-last');
        const progressContainer = document.querySelector('.clickable-progress');
        const btnShortcuts = document.getElementById('btn-shortcuts');
        
        if (btnFirst) {
            btnFirst.addEventListener('click', () => subtitlePlayer.jumpToBeginning());
        }
        
        if (btnLast) {
            btnLast.addEventListener('click', () => subtitlePlayer.jumpToEnd());
        }
        
        // Clickable progress bar
        if (progressContainer) {
            progressContainer.addEventListener('click', function(event) {
                const rect = this.getBoundingClientRect();
                const clickPosition = (event.clientX - rect.left) / rect.width;
                const targetIndex = Math.floor(clickPosition * subtitlePlayer.getTotalAlignments());
                subtitlePlayer.jumpToAlignment(targetIndex);
            });
        }
        
        // Keyboard shortcuts help
        if (btnShortcuts) {
            btnShortcuts.addEventListener('click', showKeyboardShortcuts);
        }
        
        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Prevent shortcuts when user is typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }
            
            // Ensure subtitlePlayer is initialized before handling shortcuts
            if (!subtitlePlayer) {
                console.warn('SubtitlePlayer not yet initialized');
                return;
            }
            
            try {
                switch(event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        subtitlePlayer.previousAlignment();
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        subtitlePlayer.nextAlignment();
                        break;
                    case ' ': // Spacebar
                        event.preventDefault();
                        subtitlePlayer.togglePlayback();
                        break;
                    case 'Home':
                        event.preventDefault();
                        subtitlePlayer.jumpToBeginning();
                        break;
                    case 'End':
                        event.preventDefault();
                        subtitlePlayer.jumpToEnd();
                        break;
                    case '1':
                        event.preventDefault();
                        subtitlePlayer.setPlaybackSpeed(5000); // Slow
                        break;
                    case '2':
                        event.preventDefault();
                        subtitlePlayer.setPlaybackSpeed(3000); // Normal
                        break;
                    case '3':
                        event.preventDefault();
                        subtitlePlayer.setPlaybackSpeed(1000); // Fast
                        break;
                    case 'Escape':
                        event.preventDefault();
                        if (subtitlePlayer.playbackState && subtitlePlayer.playbackState.isPlaying) {
                            subtitlePlayer.pauseAutoPlay();
                        }
                        break;
                    case '?':
                        event.preventDefault();
                        showKeyboardShortcuts();
                        break;
                }
            } catch (error) {
                console.error('Error handling keyboard shortcut:', error);
            }
        });
        
        // Keyboard shortcuts help modal
        function showKeyboardShortcuts() {
            const modalHtml = `
                <div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="shortcutsModalLabel">Keyboard Shortcuts</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Navigation</h6>
                                        <ul class="list-unstyled">
                                            <li><kbd>←</kbd> Previous alignment</li>
                                            <li><kbd>→</kbd> Next alignment</li>
                                            <li><kbd>Home</kbd> Jump to beginning</li>
                                            <li><kbd>End</kbd> Jump to end</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Playback</h6>
                                        <ul class="list-unstyled">
                                            <li><kbd>Space</kbd> Play/Pause</li>
                                            <li><kbd>1</kbd> Slow speed (5s)</li>
                                            <li><kbd>2</kbd> Normal speed (3s)</li>
                                            <li><kbd>3</kbd> Fast speed (1s)</li>
                                            <li><kbd>Esc</kbd> Pause playback</li>
                                        </ul>
                                    </div>
                                </div>
                                <hr>
                                <small class="text-muted">Press <kbd>?</kbd> anytime to show this help</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('shortcutsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('shortcutsModal'));
            modal.show();
            
            // Clean up modal after it's hidden
            document.getElementById('shortcutsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
    });
</script>
{% endblock %}